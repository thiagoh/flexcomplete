(function(e){function r(){var t=this;this._input=null;this._showTooltip=false;this._processInput=null;this._getLine=null;this._getFullText=null;this._onLoad=null;this._onUnload=null;this._onSelect=null;this._onClose=null;this._getInputValue=null;this._filter=null;this._onFilter=null;this._queryVar=null;this._method=null;this._url=null;this._data=null;this._staticDataSearch=null;this._status=null;this._delay=null;this._selectIfOneResult=null;this._showDefaultResults=null;this._extraParams=null;this._opened=null;this._father=null;this._jump=null;this._startIn=null;this._arrayFather=[];this._autoReplacing=null;this._width=null;this._scheduler=null;this._interval=null;this._defaults={_queryVar:"q",_method:"GET",_processInput:function(e){return e},_onSelect:function(e,t){t.value=e},_onFilter:function(e){},_onLoad:function(){},_onUnload:function(){},_onClose:function(){},_getFullText:function(e){return e},_getInputValue:function(e){return e},_status:e.fn.flexcomplete._variables.RUNNABLE,_delay:300,_jump:6,_startIn:3,_width:null,_selectIfOneResult:false,_showDefaultResults:true,_staticDataSearch:false,_extraParams:{},_autoReplacing:false}}var t="_fnflexcomplete.instance";var n="_fnflexcomplete.data";var i=function(t){if(t.ascii)return t;t=arguments[0]=e.event.fix(t||window.event);return new s({type:t.type,ascii:t.keyCode?t.keyCode:t.which,target:e(t.target).get(0)})};var s=function(e){this.type=e.type;this.ascii=e.ascii;this.target=e.target};e.extend(r.prototype,{extend:function(t){e.extend(this,this,t)},load:function(n){e.extend(this,this._defaults,n);var r=this;if(!r._getLine)throw new Error("You must provide a getLine implementation");r._staticDataSearch=r._data!=null;if(!r._staticDataSearch&&(!r._url||e.trim(r._url)==""))throw new Error("No database set");var i=this._input.offset();var s=this._input.outerHeight();r._width=r._width!=null?r._width:r._input.outerWidth();r._arrayFather=[];r._fatherIndex=-1;if(r._input.data(t)==undefined)r._input.data(t,this);r._input.keyup(function(t){try{e._fnflexcomplete._schedule.apply(r,[t])}catch(n){if(console)console.error(n)}}).keydown(function(t){try{e._fnflexcomplete._forwardNavigation.apply(r,[t])}catch(n){if(console)console.error(n)}}).focus(function(t){try{e._fnflexcomplete._gainFocus.apply(r,[t])}catch(n){if(console)console.error(n)}}).blur(function(t){try{e._fnflexcomplete._looseFocus.apply(r,[t])}catch(n){if(console)console.error(n)}});r._onLoad();return r},_forwardNavigation:function(e){e=i(e);if(this._isNavigation(e))this._navigate(e)},_schedule:function(t){var n=this;t=i(t);if(n._isNavigation(t))return;if(e.trim(n._input.val()).length==0||e.trim(n._input.val()).length<n._startIn){if(n.isOpened())n.close();return}var r=(new Date).getTime();if(n._scheduler&&n._scheduler.executed==true&&n._scheduler.timestamp+n._delay<r){n._scheduler.executed=false;n._scheduler.timestamp=r}else{n._scheduler={executed:false,timestamp:r}}if(t.type.toLowerCase()=="focus"){n._search.apply(n,[t]);return}if(n._interval)clearInterval(n._interval);n._interval=setInterval(function(){n._search.apply(n,[t])},n._delay)},_search:function(t){var n=this;clearInterval(n._interval);if(n._scheduler.executed==false){if(e.trim(n._input.val()).length==0||e.trim(n._input.val()).length<n._startIn){if(n.isOpened())n.close();return}if(n.status==e.fn.flexcomplete._variables.STOPPED)return false;var r={};r[n._queryVar]=n._processInput(n._input.val());if(e.isPlainObject(n._extraParams)){e.each(n._extraParams,function(t,n){r[t]=e.isFunction(n)?n():n})}else if(e.isFunction(n._extraParams)){e.each(n._extraParams(),function(t,n){r[t]=e.isFunction(n)?n():n})}if(n._staticDataSearch){var i=n._filter(n._data,n._input.get(0));n._onFilter(i);if(n._showDefaultResults)n._drawFather(i);n._scheduler.executed=true}else{e.ajax({type:n._method,dataType:"json",url:n._url,async:true,data:r,success:function(e,t){try{n._onFilter(e);if(n._showDefaultResults)n._drawFather(e);n._scheduler.executed=true}catch(r){if(console)console.error(r);throw r}},error:function(e){throw new Error(e)}})}}},_drawFather:function(t){var r=this;var i=r._input.offset();var s=r._input.outerHeight();r._arrayFather=[];r._fatherIndex=-1;if(r._father)r._father.remove();r._father=e('<div class="flexcomplete-father"></div>').css({visibility:"hidden",top:i.top+s+"px",left:i.left+"px",width:r._width+"px"});e("body").append(r._father);if(t&&t.length){for(var o=0,u=t.length;o<u;o++)r._arrayFather.push(t[o]);r._father.css({visibility:"visible"})}else r._father.css({visibility:"hidden"});r._drawChilds().open();if(r._arrayFather.length==1&&r._selectIfOneResult==true){r._onSelect(r._arrayFather[0].data(n),r._input.get(0));if(r.isOpened())r.close()}},reMap:{},_matchText:function(t,n){var r=this;if(!n||e.trim(n)=="")return r._getFullText(obj);if(!r.reMap[n])r.reMap[n]=new RegExp("("+n.replace(/([\]^\${}|+().\[\\])/g,"\\$1")+")","ig");return r._getFullText(obj).replace(r.reMap[n],"<span class='flexcomplete-matched'>$1</span>")},_drawChilds:function(){var r=this;r._father.html("");var i=r._input.val();for(var s=0;s<r._arrayFather.length;s++){var o=r._arrayFather[s];var u=r._getLine(o);var a=e("<div class='flexcomplete-line'></div>").append(u);if(r._showTooltip&&e.tooltip)a.attr("title",r._getFullText(o)).tooltip({showURL:false,delay:80});r._arrayFather[s]=e("<div align='left' class='flexcomplete-line-common'></div>").data(n,o).data(t,r).append(a).mousedown(r.choosingClick).mouseover(r.mouseOver).mouseout(r.mouseOut);r._father.append(r._arrayFather[s])}return r},_isNavigation:function(t){var n=t.ascii,r=e.fn.flexcomplete._variables;return n==r.KEY_TO_UP||n==r.KEY_TO_DOWN||n==r.KEY_TO_LEFT||n==r.KEY_TO_RIGHT||n==r.KEY_ENTER||n==r.KEY_PAGE_UP||n==r.KEY_PAGE_DOWN||n==r.KEY_ESC||n==r.KEY_HOME||n==r.KEY_END},_hover:function(e,t){var n=this;if(e>=0)n._arrayFather[e].find(".flexcomplete-line:first").removeClass("flexcomplete-line-hover");if(t>=0)n._arrayFather[t].find(".flexcomplete-line:first").addClass("flexcomplete-line-hover")},_navigate:function(t){var r=this;var i=t.ascii;var s=e.fn.flexcomplete._variables;if(i==s.KEY_ESC){r.close();return}var o=r._fatherIndex;if(r._arrayFather.length>=1){if(i==s.KEY_TO_UP||i==s.KEY_TO_DOWN||i==s.KEY_PAGE_UP||i==s.KEY_PAGE_DOWN){if(i==s.KEY_TO_UP){r._fatherIndex=r._fatherIndex>=1?r._fatherIndex-1:r._arrayFather.length-1}else if(i==s.KEY_TO_DOWN){r._fatherIndex=r._fatherIndex<r._arrayFather.length-1?r._fatherIndex+1:0}else if(i==s.KEY_PAGE_UP){r._fatherIndex=r._fatherIndex-r._jump>=0?r._fatherIndex-r._jump:0}else if(i==s.KEY_PAGE_DOWN){r._fatherIndex=r._fatherIndex+r._jump<r._arrayFather.length?r._fatherIndex+r._jump:r._arrayFather.length-1}r._hover(o,r._fatherIndex)}else if(i==s.KEY_ENTER){if(r._fatherIndex>=0)r._onSelect(r._arrayFather[r._fatherIndex].data(n),r._input.get(0));if(r.isOpened())r.close();return}}if(r._autoReplacing==true&&r._fatherIndex>=0&&r._arrayFather.length>=1)r._input.val(r._getInputValue(r._arrayFather[r._fatherIndex].data(n)));r.open()},choosingClick:function(r){r=i(r);var s=e(r.target);if(!s.hasClass("flexcomplete-line-common"))s=s.parents("div.flexcomplete-line-common");var o=s.data(t);o._onSelect(s.data(n),o._input.get(0));if(o.isOpened())o.close()},mouseOver:function(t){var n=e(t.target);n=n.is(".flexcomplete-line")?n:n.find(".flexcomplete-line:first");n.addClass("flexcomplete-line-hover")},mouseOut:function(t){var n=e(t.target);n=n.is(".flexcomplete-line")?n:n.find(".flexcomplete-line:first");n.removeClass("flexcomplete-line-hover")},_looseFocus:function(e){if(this.isOpened())this.close(i(e))},_gainFocus:function(e){this._schedule(i(e))},setStatus:function(t){if(t!=e.fn.flexcomplete._variables.STOPPED&&t!=e.fn.flexcomplete._variables.RUNNABLE)t=e.fn.flexcomplete._variables.STOPPED;this.status=t},select:function(e){this._onSelect(e,this._input.get(0))},close:function(e){if(this._father!=null)this._father.css({visibility:"hidden"}).remove();this._arrayFather=[];this.opened=false;this._onClose()},open:function(){this.opened=true},isOpened:function(){return this.opened},search:function(){var t=this;return t._schedule(new s({type:"keyup",target:t._input,ascii:e.fn.flexcomplete._variables.KEY_DO_SEARCH}))},sdata:function(e){if(e)this._data=e;return this._data},unload:function(){var n=this;try{n.close();n.setStatus(e.fn.flexcomplete._variables.STOPPED);n._input.unbind("keyup",n._schedule);n._input.unbind("keydown",n._forwardNavigation);n._input.unbind("focus",n._gainFocus);n._input.unbind("blur",n._looseFocus);n._father.remove();n._input.removeData(t)}catch(r){}n._onUnload()}});e.fn.flexcomplete=function(n){if(e.isFunction(this.each)){var i=e(this).data(t);if(!i){return this.each(function(){if(i==undefined){var i=new r;i._input=e(this);var s={};e.each(n,function(e,t){s["_"+e]=t});i.load(s);e(this).data(t,i)}return this})}if(typeof n=="string"){var s=Array.prototype.slice.call(arguments,1);if(n=="close"||n=="search"||n=="select"||n=="unload"||n=="sdata"){return e._fnflexcomplete[n].apply(i,s)}else if(n=="extend"){s=s[0];var o={};e.each(s,function(e,t){o["_"+e]=t});return e._fnflexcomplete[n].apply(i,[o])}}}};e.fn.unflexcomplete=function(){if(e.isFunction(this.each)){return this.each(function(){if(e(this).data(t))e(this).data(t).unload();return this})}};e.fn.flexcomplete.reReplace=/([\]^\${}|!@#\*\-+()\'.\[\\])/g;e.fn.flexcomplete._variables={KEY_DO_SEARCH:11111,KEY_ENTER:13,KEY_TO_LEFT:37,KEY_TO_RIGHT:39,KEY_TO_UP:38,KEY_TO_DOWN:40,KEY_BACKSPACE:8,KEY_INSERT:45,KEY_DELETE:46,KEY_SHIFT:16,KEY_CTRL:17,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_ESC:27,KEY_TAB:9,KEY_HOME:36,KEY_END:35,STOPPED:0,RUNNABLE:1};e._fnflexcomplete=new r})(jQuery)