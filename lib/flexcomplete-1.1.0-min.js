!function(t){"use strict";var e="_flexcomplete.instance",a="_flexcomplete.data",n={KEY_DO_SEARCH:11111,KEY_ENTER:13,KEY_TO_LEFT:37,KEY_TO_RIGHT:39,KEY_TO_UP:38,KEY_TO_DOWN:40,KEY_BACKSPACE:8,KEY_INSERT:45,KEY_DELETE:46,KEY_SHIFT:16,KEY_CTRL:17,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_ESC:27,KEY_TAB:9,KEY_HOME:36,KEY_END:35,STOPPED:0,RUNNABLE:1},i=function(){return this._defaults={_queryVar:"q",_method:"GET",_processInput:function(t){return t},_onSelect:function(t,e){e.value=t},_onFilter:function(){},_onLoad:function(){},_onUnload:function(){},_onClose:function(){},_getFullText:function(t){return t},_getInputValue:function(t){return t},_status:n.RUNNABLE,_delay:300,_jump:6,_startIn:3,_width:null,_selectIfOneResult:!1,_showDefaultResults:!0,_staticDataSearch:!1,_extraParams:{},_autoReplacing:!1},this},r=function(e){return e.ascii?e:(e=t.event.fix(e||window.event),{type:e.type,ascii:e.keyCode?e.keyCode:e.which,target:t(e.target).get(0)})};t.extend(i.prototype,{extend:function(e){t.extend(this,this,e)},load:function(a){var n=this;if(a=t.extend({},this._defaults,a),this._input=a._input||null,this._showTooltip=a._showTooltip||!1,this._processInput=a._processInput||null,this._getLine=a._getLine||null,this._getFullText=a._getFullText||null,this._onLoad=a._onLoad||null,this._onUnload=a._onUnload||null,this._onSelect=a._onSelect||null,this._onClose=a._onClose||null,this._getInputValue=a._getInputValue||null,this._filter=a._filter||null,this._onFilter=a._onFilter||null,this._queryVar=a._queryVar||null,this._method=a._method||null,this._url=a._url||null,this._data=a._data||null,this._status=a._status||null,this._delay=a._delay||null,this._selectIfOneResult=a._selectIfOneResult||null,this._showDefaultResults=a._showDefaultResults||null,this._extraParams=a._extraParams||null,this._opened=a._opened||null,this._father=a._father||null,this._jump=a._jump||null,this._startIn=a._startIn||null,this._arrayFather=a._arrayFather||[],this._autoReplacing=a._autoReplacing||null,this._width=a._width||null,this._scheduler=a._scheduler||null,this._interval=a._interval||null,!this._getLine)throw new Error("You must provide a getLine implementation");if(this._staticDataSearch="undefined"!=typeof this._data,!(this._staticDataSearch||this._url&&""!==t.trim(this._url)))throw new Error("No database set");return this._width="undefined"!=typeof this._width&&null!==this._width?this._width:this._input.outerWidth(),this._arrayFather=[],this._fatherIndex=-1,"undefined"==typeof this._input.data(e)&&this._input.data(e,this),this._input.keyup(function(t){i.prototype._schedule.call(n,t)}).keydown(function(t){i.prototype._forwardNavigation.call(n,t)}).focus(function(t){i.prototype._gainFocus.call(n,t)}).blur(function(t){i.prototype._looseFocus.call(n,t)}),this._onLoad(),this},_forwardNavigation:function(t){t=r(t),this._isNavigation(t)&&this._navigate(t)},_schedule:function(e){var a=this;if(e=r(e),!a._isNavigation(e)){if(0===t.trim(a._input.val()).length||t.trim(a._input.val()).length<a._startIn)return void(a.isOpened()&&a.close());var n=(new Date).getTime();if(a._scheduler&&a._scheduler.executed===!0&&a._scheduler.timestamp+a._delay<n?(a._scheduler.executed=!1,a._scheduler.timestamp=n):a._scheduler={executed:!1,timestamp:n},"focus"==e.type.toLowerCase())return void a._search.call(a,e);a._interval&&clearInterval(a._interval),a._interval=setInterval(function(){a._search.call(a,e)},a._delay)}},_search:function(){var e=this;if(clearInterval(e._interval),e._scheduler.executed===!1){if(0===t.trim(e._input.val()).length||t.trim(e._input.val()).length<e._startIn)return void(e.isOpened()&&e.close());if(e.status==n.STOPPED)return!1;var a={};if(a[e._queryVar]=e._processInput(e._input.val()),t.isPlainObject(e._extraParams)?t.each(e._extraParams,function(e,n){a[e]=t.isFunction(n)?n():n}):t.isFunction(e._extraParams)&&t.each(e._extraParams(),function(e,n){a[e]=t.isFunction(n)?n():n}),e._staticDataSearch){var i=e._filter(e._data,e._input.get(0));e._onFilter(i),e._showDefaultResults&&e._drawFather(i),e._scheduler.executed=!0}else t.ajax({type:e._method,dataType:"json",url:e._url,async:!0,data:a,success:function(t){e._onFilter(t),e._showDefaultResults&&e._drawFather(t),e._scheduler.executed=!0},error:function(t){throw new Error(t)}})}},_drawFather:function(e){var n=this,i=n._input.offset(),r=n._input.outerHeight();if(n._arrayFather=[],n._fatherIndex=-1,n._father&&n._father.remove(),n._father=t('<div class="flexcomplete-father"></div>').css({visibility:"hidden",top:i.top+r+"px",left:i.left+"px",width:n._width+"px"}),t("body").append(n._father),e&&e.length){for(var _=0,l=e.length;l>_;_++)n._arrayFather.push(e[_]);n._father.css({visibility:"visible"})}else n._father.css({visibility:"hidden"});n._drawChilds().open(),1===n._arrayFather.length&&n._selectIfOneResult===!0&&(n._onSelect(n._arrayFather[0].data(a),n._input.get(0)),n.isOpened()&&n.close())},reMap:{},_matchText:function(e,a){var n=this;return a&&""!==t.trim(a)?(n.reMap[a]||(n.reMap[a]=new RegExp("("+a.replace(/([\]^\${}|+().\[\\])/g,"\\$1")+")","ig")),n._getFullText(obj).replace(n.reMap[a],"<span class='flexcomplete-matched'>$1</span>")):n._getFullText(obj)},_drawChilds:function(){var n=this;n._father.html("");for(var i=(n._input.val(),0);i<n._arrayFather.length;i++){var r=n._arrayFather[i],_=n._getLine(r),l=t("<div class='flexcomplete-line'></div>").append(_);n._showTooltip&&t.tooltip&&l.attr("title",n._getFullText(r)).tooltip({showURL:!1,delay:80}),n._arrayFather[i]=t("<div align='left' class='flexcomplete-line-common'></div>").data(a,r).data(e,n).append(l).mousedown(n.choosingClick).mouseover(n.mouseOver).mouseout(n.mouseOut),n._father.append(n._arrayFather[i])}return n},_isNavigation:function(t){var e=t.ascii,a=n;return e==a.KEY_TO_UP||e===a.KEY_TO_DOWN||e===a.KEY_TO_LEFT||e===a.KEY_TO_RIGHT||e===a.KEY_ENTER||e===a.KEY_PAGE_UP||e===a.KEY_PAGE_DOWN||e===a.KEY_ESC||e===a.KEY_HOME||e===a.KEY_END},_hover:function(t,e){var a=this;t>=0&&a._arrayFather[t].find(".flexcomplete-line:first").removeClass("flexcomplete-line-hover"),e>=0&&a._arrayFather[e].find(".flexcomplete-line:first").addClass("flexcomplete-line-hover")},_navigate:function(t){var e=this,i=t.ascii,r=n;if(i==r.KEY_ESC)return void e.close();var _=e._fatherIndex;if(e._arrayFather.length>=1)if(i===r.KEY_TO_UP||i===r.KEY_TO_DOWN||i===r.KEY_PAGE_UP||i===r.KEY_PAGE_DOWN)i===r.KEY_TO_UP?e._fatherIndex=e._fatherIndex>=1?e._fatherIndex-1:e._arrayFather.length-1:i===r.KEY_TO_DOWN?e._fatherIndex=e._fatherIndex<e._arrayFather.length-1?e._fatherIndex+1:0:i===r.KEY_PAGE_UP?e._fatherIndex=e._fatherIndex-e._jump>=0?e._fatherIndex-e._jump:0:i===r.KEY_PAGE_DOWN&&(e._fatherIndex=e._fatherIndex+e._jump<e._arrayFather.length?e._fatherIndex+e._jump:e._arrayFather.length-1),e._hover(_,e._fatherIndex);else if(i===r.KEY_ENTER)return e._fatherIndex>=0&&e._onSelect(e._arrayFather[e._fatherIndex].data(a),e._input.get(0)),void(e.isOpened()&&e.close());e._autoReplacing===!0&&e._fatherIndex>=0&&e._arrayFather.length>=1&&e._input.val(e._getInputValue(e._arrayFather[e._fatherIndex].data(a))),e.open()},choosingClick:function(n){n=r(n);var i=t(n.target);i.hasClass("flexcomplete-line-common")||(i=i.parents("div.flexcomplete-line-common"));var _=i.data(e);_._onSelect(i.data(a),_._input.get(0)),_.isOpened()&&_.close()},mouseOver:function(e){var a=t(e.target);a=a.is(".flexcomplete-line")?a:a.find(".flexcomplete-line:first"),a.addClass("flexcomplete-line-hover")},mouseOut:function(e){var a=t(e.target);a=a.is(".flexcomplete-line")?a:a.find(".flexcomplete-line:first"),a.removeClass("flexcomplete-line-hover")},_looseFocus:function(t){this.isOpened()&&this.close(r(t))},_gainFocus:function(t){this._schedule(r(t))},setStatus:function(t){t!=n.STOPPED&&t!=n.RUNNABLE&&(t=n.STOPPED),this.status=t},select:function(t){this._onSelect(t,this._input.get(0))},close:function(){"undefined"!=typeof this._father&&this._father.css({visibility:"hidden"}).remove(),this._arrayFather=[],this.opened=!1,this._onClose()},open:function(){this.opened=!0},isOpened:function(){return this.opened},search:function(){var t=this;return t._schedule({type:"keyup",target:t._input,ascii:n.KEY_DO_SEARCH})},staticData:function(t){return"undefined"!=typeof t&&(this._data=t),this._data},sdata:function(t){return this.staticData(t)},unload:function(){var t=this;try{t.close(),t.setStatus(n.STOPPED),t._input.unbind("keyup",t._schedule),t._input.unbind("keydown",t._forwardNavigation),t._input.unbind("focus",t._gainFocus),t._input.unbind("blur",t._looseFocus),t._father.remove(),t._input.removeData(e)}catch(a){}t._onUnload()}}),t.fn.flexcomplete=function(a){var n,r,_=t(this).data(e),l=Array.prototype.slice.call(arguments,1);if("string"!=typeof a)return this.each(function(){return"undefined"==typeof t(this).data(e)&&"object"==typeof a?(r=new i,n={},t.each(a,function(t,e){n["_"+t]=e}),n._input=t(this),r.load(n),t(this).data(e,r),this):void 0});if("close"===a||"search"===a||"select"===a||"unload"===a||"staticData"===a||"sdata"==a){var s=_[a].apply(_,l);return s}return"extend"===a?(l=l[0],n={},t.each(l,function(t,e){n["_"+t]=e}),_[a].call(_,n)):void 0},t.fn.unflexcomplete=function(){return this.each(function(){return t(this).data(e)&&t(this).data(e).unload(),this})}}(jQuery);